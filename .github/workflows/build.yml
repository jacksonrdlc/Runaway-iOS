name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-15

    steps:
    - uses: actions/checkout@v4

    - name: Setup Mapbox SDK authentication
      env:
        MAPBOX_SECRET_TOKEN: ${{ secrets.MAPBOX_SECRET_TOKEN }}
      run: |
        echo "=== Mapbox Auth Debug ==="
        if [ -z "$MAPBOX_SECRET_TOKEN" ]; then
          echo "::warning::MAPBOX_SECRET_TOKEN not set - Mapbox packages may fail to download"
          echo "Continuing without Mapbox auth..."
        else
          echo "✓ MAPBOX_SECRET_TOKEN is set (length: ${#MAPBOX_SECRET_TOKEN} chars)"
          # Mapbox requires auth for multiple domains
          echo "machine api.mapbox.com" > ~/.netrc
          echo "login mapbox" >> ~/.netrc
          echo "password ${MAPBOX_SECRET_TOKEN}" >> ~/.netrc
          echo "" >> ~/.netrc
          echo "machine api.mapbox.cn" >> ~/.netrc
          echo "login mapbox" >> ~/.netrc
          echo "password ${MAPBOX_SECRET_TOKEN}" >> ~/.netrc
          chmod 600 ~/.netrc
          echo "✓ .netrc configured"
        fi
        echo "=== Mapbox Auth Complete ==="

    - name: Create Info.plist from template
      run: |
        cp Runaway-iOS-Info.plist.template Runaway-iOS-Info.plist
        # Use placeholder values for CI build - secrets not needed for compile check
        sed -i '' "s|YOUR_MAPBOX_TOKEN_HERE|pk.placeholder|g" Runaway-iOS-Info.plist
        sed -i '' "s|YOUR_SUPABASE_PROJECT_URL_HERE|https://placeholder.supabase.co|g" Runaway-iOS-Info.plist
        sed -i '' "s|YOUR_SUPABASE_ANON_KEY_HERE|placeholder_key|g" Runaway-iOS-Info.plist
        sed -i '' "s|YOUR_RUNAWAY_API_KEY_HERE|placeholder_api_key|g" Runaway-iOS-Info.plist
        echo "✓ Info.plist created from template with placeholder values"

    - name: Select Xcode 16
      run: |
        sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer || \
        sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer || \
        sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer || \
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        xcodebuild -version

    - name: Install iOS Simulator
      run: |
        sudo xcodebuild -downloadPlatform iOS
      continue-on-error: true

    - name: List available simulators and SDKs
      run: |
        echo "=== Available SDKs ==="
        xcodebuild -showsdks
        echo ""
        echo "=== Available iOS Simulators ==="
        xcrun simctl list devices available | grep -E "iPhone|iOS" || true
        echo ""
        echo "=== Available Runtimes ==="
        xcrun simctl list runtimes

    - name: Resolve Swift packages
      run: |
        echo "=== Resolving Swift Package Dependencies ==="
        xcodebuild -project "Runaway iOS.xcodeproj" \
          -scheme "Runaway iOS" \
          -resolvePackageDependencies 2>&1 | tee package_resolution.log
        echo "=== Package Resolution Complete ==="
        if grep -i "error\|failed\|unauthorized" package_resolution.log; then
          echo "::warning::Package resolution may have issues - check log above"
        fi

    - name: Build
      run: |
        xcodebuild -project "Runaway iOS.xcodeproj" \
          -scheme "Runaway iOS" \
          -sdk iphonesimulator \
          -destination "generic/platform=iOS Simulator" \
          -skipPackagePluginValidation \
          SWIFT_STRICT_CONCURRENCY=minimal \
          build
